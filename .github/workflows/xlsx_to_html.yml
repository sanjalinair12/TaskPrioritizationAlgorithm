name: Convert XLSX to HTML and Publish to GitHub Pages

on:
  push:
    paths:
      - "**/*.xlsx"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pandas openpyxl

      - name: Convert XLSX to HTML
        run: |
          mkdir -p html_previews
          for file in $(find . -name "*.xlsx"); do
            base=$(basename "${file%.xlsx}")
            python - <<EOF
import pandas as pd
df = pd.read_excel("$file")
html = df.to_html(index=False)
open(f"html_previews/${base}.html", "w").write(html)
EOF
          done

      - name: Add DataTables for interactivity
        run: |
          for f in html_previews/*.html; do
            cat <<EOF > temp.html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
</head>
<body>
<script>
  \$(document).ready(function() {
    \$('table').DataTable();
  });
</script>
EOF
            cat "$f" >> temp.html
            echo "</body></html>" >> temp.html
            mv temp.html "$f"
          done

      - name: Upload HTML preview artifacts
        uses: actions/upload-pages-artifact@v2
        with:
          path: html_previews

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2
